name: Sync Fork with Upstream

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync from obra/superpowers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/obra/superpowers.git
          git fetch upstream main

      - name: Check for upstream changes
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "behind=$BEHIND" >> "$GITHUB_OUTPUT"
          echo "Commits behind upstream: $BEHIND"

      - name: Create sync PR if behind
        if: steps.check.outputs.behind != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BEHIND_COUNT: ${{ steps.check.outputs.behind }}
        run: |
          SYNC_BRANCH="sync/upstream-$(date +%Y%m%d)"
          git checkout -b "$SYNC_BRANCH"

          if git merge upstream/main --no-edit; then
            git push origin "$SYNC_BRANCH"

            COMMIT_LOG=$(git log --oneline "HEAD~${BEHIND_COUNT}..HEAD" | head -20)

            gh pr create \
              --title "Sync: ${BEHIND_COUNT} commits from upstream obra/superpowers" \
              --body "## Upstream Sync

          **${BEHIND_COUNT} new commit(s)** from [obra/superpowers](https://github.com/obra/superpowers)

          ### Changes included
          \`\`\`
          ${COMMIT_LOG}
          \`\`\`

          ### Review checklist
          - [ ] Changes don't conflict with our customizations
          - [ ] CI passes
          - [ ] Skills still load correctly

          ---
          Auto-generated by sync workflow" \
              --base main \
              --head "$SYNC_BRANCH"

            echo "PR created for sync branch: $SYNC_BRANCH"
          else
            echo "Merge conflicts detected! Manual resolution needed."
            echo "To resolve locally:"
            echo "  git fetch upstream main"
            echo "  git merge upstream/main"
            exit 1
          fi
